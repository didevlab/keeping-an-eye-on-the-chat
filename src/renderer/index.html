<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Overlay Shell</title>
    <link rel="stylesheet" href="./avatarUI.css" />
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        background: transparent;
        overflow: hidden;
      }

      #debug-frame {
        position: fixed;
        inset: 8px;
        border: 1px solid rgba(0, 255, 255, 0.35);
        border-radius: 6px;
        display: none;
        box-sizing: border-box;
        pointer-events: none;
      }

      #debug-label {
        position: absolute;
        top: 6px;
        left: 6px;
        padding: 2px 6px;
        font: 12px/1.2 "Courier New", monospace;
        color: rgba(0, 255, 255, 0.9);
        background: rgba(0, 0, 0, 0.35);
        border-radius: 4px;
        letter-spacing: 0.02em;
        pointer-events: none;
      }

      #debug-count {
        display: inline-block;
        margin-left: 6px;
        padding: 1px 6px;
        font-size: 11px;
        color: rgba(0, 255, 255, 0.95);
        background: rgba(0, 255, 255, 0.15);
        border-radius: 999px;
      }

      #debug-panel {
        position: absolute;
        top: 34px;
        left: 6px;
        min-width: 220px;
        padding: 6px 8px;
        font: 12px/1.4 "Courier New", monospace;
        color: rgba(0, 255, 255, 0.9);
        background: rgba(0, 0, 0, 0.35);
        border-radius: 4px;
        display: none;
        pointer-events: none;
      }

      #debug-active {
        display: inline-block;
        max-width: 360px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: bottom;
      }

      .debug #debug-frame {
        display: block;
      }

      .debug #debug-panel {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="debug-frame" aria-hidden="true">
      <div id="debug-label">
        Overlay Debug
        <span id="debug-count">0</span>
      </div>
      <div id="debug-panel">
        <div>Active: <span id="debug-active">none</span></div>
        <div>Queue: <span id="debug-queue">0</span></div>
        <div>Received: <span id="debug-received">0</span></div>
        <div>Displayed: <span id="debug-displayed">0</span></div>
        <div>Dropped: <span id="debug-dropped">0</span></div>
        <div>Ignored: <span id="debug-ignored">0</span></div>
        <div>Truncated: <span id="debug-truncated">0</span></div>
      </div>
    </div>
    <script src="../../node_modules/@rive-app/canvas/rive.js"></script>
    <script src="./riveAvatarController.js"></script>
    <script src="./displayController.js"></script>
    <script src="./avatarUI.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const debugEnabled = params.get('debug') === '1';
      if (debugEnabled) {
        document.documentElement.classList.add('debug');
      }

      const config = window.overlayChat?.getConfig?.() || {};
      const displaySeconds = config.displaySeconds || 5;
      const overlayAnchor = config.overlayAnchor || 'bottom-left';
      const overlayMargin =
        typeof config.overlayMargin === 'number' ? config.overlayMargin : 24;
      const bubbleMaxWidth =
        typeof config.bubbleMaxWidth === 'number' ? config.bubbleMaxWidth : 420;
      const maxMessageLength =
        typeof config.maxMessageLength === 'number' ? config.maxMessageLength : 140;
      const ignoreCommandPrefix =
        typeof config.ignoreCommandPrefix === 'string' ? config.ignoreCommandPrefix : '!';
      const ignoreUsers = Array.isArray(config.ignoreUsers)
        ? config.ignoreUsers
        : [];
      const maxQueueLength =
        typeof config.maxQueueLength === 'number' ? config.maxQueueLength : 50;
      const exitAnimationMs =
        typeof config.exitAnimationMs === 'number' ? config.exitAnimationMs : 400;
      const diagnostics = Boolean(config.diagnostics);
      const channelName =
        typeof config.channelName === 'string' ? config.channelName : '';
      const normalizedChannel = channelName.trim().toLowerCase();

      const emojiPattern = /\p{Extended_Pictographic}/gu;
      const countEmojis = (text) => {
        if (!text) {
          return 0;
        }
        const matches = text.match(emojiPattern);
        return matches ? matches.length : 0;
      };

      const shouldTriggerReact = (message) => {
        if (!message || typeof message.text !== 'string') {
          return false;
        }

        const text = message.text;
        const textLower = text.toLowerCase();
        const hasMention =
          text.includes('@') ||
          (normalizedChannel && textLower.includes(normalizedChannel));
        const emoteHeavy = countEmojis(text) >= 3;
        const longMessage = text.length > maxMessageLength * 0.7;

        return hasMention || emoteHeavy || longMessage;
      };

      const avatarUI = new window.AvatarUI({
        root: document.body,
        anchor: overlayAnchor,
        margin: overlayMargin,
        bubbleMaxWidth
      });

      const avatarSelector = '.avatar-ui__avatar';
      const avatarEl = avatarUI.avatar || document.querySelector(avatarSelector);
      if (diagnostics) {
        console.info('[diagnostics] [rive] init start');
        console.info(
          `[diagnostics] [rive] avatar container ${avatarEl ? 'found' : 'missing'} (${avatarSelector})`
        );
        if (!window.RiveAvatarController) {
          console.info('[diagnostics] [rive] controller script not loaded');
        }
      }

      const riveController =
        window.RiveAvatarController && avatarEl
          ? new window.RiveAvatarController({
              container: avatarEl,
              assetPath: './assets/mascot.riv',
              artboard: 'Mascot',
              stateMachine: 'Overlay',
              diagnostics
            })
          : null;
      if (diagnostics && !riveController) {
        console.info('[diagnostics] [rive] fallback: CSS avatar active');
      }

      let lastActiveMessageId = null;

      const controller = new window.DisplayController({
        displaySeconds,
        exitAnimationMs,
        diagnostics,
        maxMessageLength,
        ignoreCommandPrefix,
        ignoreUsers,
        maxQueueLength,
        onUpdate: (state) => {
          avatarUI.setActiveMessage(state.activeMessage);
          if (riveController) {
            const activeMessage = state.activeMessage;
            const activeId = activeMessage
              ? activeMessage.id || `${activeMessage.user}:${activeMessage.text}`
              : null;

            if (activeId && activeId !== lastActiveMessageId) {
              riveController.setTalking(true);
              if (shouldTriggerReact(activeMessage)) {
                riveController.triggerReact();
              }
              lastActiveMessageId = activeId;
            } else if (!activeId && lastActiveMessageId !== null) {
              riveController.setTalking(false);
              riveController.setIdle();
              lastActiveMessageId = null;
            }
          }

          if (!debugEnabled) {
            return;
          }

          const activeEl = document.getElementById('debug-active');
          const queueEl = document.getElementById('debug-queue');
          const receivedEl = document.getElementById('debug-received');
          const displayedEl = document.getElementById('debug-displayed');
          const droppedEl = document.getElementById('debug-dropped');
          const ignoredEl = document.getElementById('debug-ignored');
          const truncatedEl = document.getElementById('debug-truncated');
          const countEl = document.getElementById('debug-count');

          if (activeEl) {
            activeEl.textContent = state.activeMessage
              ? `${state.activeMessage.user}: ${state.activeMessage.text}`
              : 'none';
          }

          if (queueEl) {
            queueEl.textContent = String(state.queueLength);
          }

          if (receivedEl) {
            receivedEl.textContent = String(state.totalReceived);
          }

          if (displayedEl) {
            displayedEl.textContent = String(state.totalDisplayed);
          }

          if (droppedEl) {
            droppedEl.textContent = String(state.droppedCount);
          }

          if (ignoredEl) {
            ignoredEl.textContent = String(state.ignoredCount);
          }

          if (truncatedEl) {
            truncatedEl.textContent = String(state.truncatedCount);
          }

          if (countEl) {
            countEl.textContent = String(state.totalReceived);
          }
        }
      });

      if (window.overlayChat && window.overlayChat.onMessage) {
        window.overlayChat.onMessage((message) => {
          console.log('[chat-message]', message);
          controller.enqueue(message);
        });
      }
    </script>
  </body>
</html>
